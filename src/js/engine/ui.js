define([
	"jquery",
	"snapsvg",
	"jquery.pub-sub"
], function( $, Snap ) {
	'use strict';

	var UI = {},
	    stage = null,
		viewport = null;

	UI.getStage = function(stage_id) {

		if (stage) return stage;

		stage = new Snap()
			.attr({
				"id": stage_id,
				"class": "pannable"
			});

		stage = stage.node;

		// clean up unwanted desc element generated by SnapSVG
		$(stage).children("desc:first").remove();
		return stage;
	};

	UI.getViewport = function(viewport_id){
		if (viewport) return viewport;

		viewport = Snap(stage).g().attr({
			"id": viewport_id
		});

		// create dummy scene for SVGPanZoom
		var placeholder = viewport.rect(0,0,1026,546).attr({
			"opacity": "0",
			"class": "no-pointer-events"
		});

		// Method to remove the dummy object after first render
		UI.removePlaceholder = function(){
			placeholder.remove();
			placeholder = null;
			delete UI.removePlaceholder;
		};

		viewport = viewport.node;
		return viewport;
	};

	/**
	 * @param selector - Selector that points to the panel's DOM node
	 * @constructor
	 */
	function Panel( selector ) {
		this.node = $(selector);

		/**
		 * @member {string} selector
		 */

		/**
		 * To be called when the panel's default action is completed
		 * @function
		 * @name onComplete
		 * @instance
		 */

		/**
		 * To be called when the panel is fully shown
		 * @function
		 * @name onVisible
		 * @instance
		 */
	}

	/** Populate data into the fields inside the panel */
	Panel.prototype.populate = function( data ) {
		for(var field in data) {
			if(data.hasOwnProperty(field)) {
				this.node.find("[data-label='" + field + "']")
				    .text(data[field]);
			}
		}
	};

	/** Display the panel */
	Panel.prototype.show = function() {
		// Hide all
		$("#action-panel").find("section").hide();
		// Then show only this
		this.node.show();
		// Mark it as active panel
		UI.UserActionPanel.activePanel = this;
	};

	/**
	 * @namespace UserActionPanel
	 * @memberOf UI.
	 */
	UI.UserActionPanel = {
		/** @type {Panel[]} */
		Panels: [],
		/** Current active panel */
		activePanel: null,
		/**
		 * Use slide animation to reveal UserActionPanel
		 * @param {function} callback - Function to be called when show animation is completed
		 */
		open: function( callback ) {
			var c = $.Callbacks();
			c.add(UI.UserActionPanel.activePanel.onVisible);
			if(typeof callback==="function") {
				c.add(callback());
			}

			$("#stage-box-slide").animate(
				{ "bottom": $("#action-panel") .height()},
				250,
				"easeOutCubic",
				$.proxy(c.fire, this.activePanel)
			);
		},
		/**
		 * Use slide animation to hide UserActionPanel
		 * @param {function} callback - Function to be called when hide animation is completed
		 */
		close: function( callback ) {
			$("#stage-box-slide").animate(
				{"bottom": 0},
				250,
				"easeOutCubic",
				callback
			);
		},
		/** Reset panels in UserActionPanel */
		reset: function() {
			$("#action-panel").find("section").removeClass("done").hide();
		},
		/**
		 * Control events dedicated for UserActionPanel
		 * @param {string} data.show - Identifier of the panel to show
		 * @param {object} [data.info] - Data to populate to UI
		 */
		handler: function( evt, data ) {
			//Handle panel display
			if(typeof data.show !== "undefined" && UI.UserActionPanel.Panels.hasOwnProperty(data.show)) {
				// Identify panel
				var panel = UI.UserActionPanel.Panels[data.show];
				//Populate data
				if(typeof data.info !== "undefined"){
					panel.populate(data.info);
				}
				// Display panel
				panel.show();
				// Slide open UserActionPanel
				UI.UserActionPanel.open();
			}
		}
	};

	// Register handler for UserActionPanel
	$.subscribe("UI.UserActionPanel", UI.UserActionPanel.handler);

	// Signals player's turn ended
	function Evt_Fire_PlayerEndsTurn(){
		$.publish("PlayerEndsTurn");
	}

	var Panels = /** @lends UI.UserActionPanel.Panels */{
		"PROPERTY_BUY": /** @type {Panel} */{
			selector: "#action-panel-buy",
			onVisible: function() {
				// Focus default button
				this.node.find("button.main").focus();
			},
			onComplete: function() {
				// Show success animation
				this.node.removeClass("done").addClass("done");
				// Hide player action panel
				window.setTimeout(UI.UserActionPanel.close, 1000);
				// Ends turn
				window.setTimeout(Evt_Fire_PlayerEndsTurn, 1500);
			}
		},
		"PROPERTY_UPGRADE": /** @type {Panel} */{
			selector: "#action-panel-upgrade",
			onVisible: function() {
				// Focus default button
				this.node.find("button.main").focus();
			},
			onComplete: function() {
				// Show success animation
				this.node.removeClass("done").addClass("done");
				// Hide player action panel
				window.setTimeout(UI.UserActionPanel.close, 1000);
				// Ends turn
				window.setTimeout(Evt_Fire_PlayerEndsTurn, 1500);
			}
		}
	};

	// Register panels using the definitions
	for(var id in Panels) {
		if(Panels.hasOwnProperty(id)){
			var panel = Panels[id];
			// Define panel instance
			UI.UserActionPanel.Panels[id] = new Panel(panel.selector);

			// Attach customizations
			for(var prop in panel) {
				if(panel.hasOwnProperty(prop)) {
					UI.UserActionPanel.Panels[id][prop] = panel[prop];
				}
			}
		}
	}

	/**
	 * @namespace DiceButton
	 * @memberOf UI.
	 */
	UI.DiceButton = {
		/** Enable DiceButton */
		enable: function() {
			$("#btn-roll").removeClass("disabled");
		},
		/** Disable DiceButton */
		disable: function() {
			$("#btn-roll").addClass("disabled");
		},
		/** Control events dedicated for DiceButton */
		handler: function( evt, data ) {
			// Handle enable/disable
			if(typeof data.enabled !== "undefined" && data.enabled) {
				UI.DiceButton.enable();
			} else {
				UI.DiceButton.disable();
			}
		}
	};

	// Register handler for DiceButton
	$.subscribe("UI.DiceButton", UI.DiceButton.handler);

	return UI;
});